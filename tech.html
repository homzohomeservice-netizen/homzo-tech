<!DOCTYPE html>
<html>
<head>
    <title>Technician Panel - Homzo</title>
    <link rel="stylesheet" href="style.css">

    <!-- Firebase v8 CDN -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <script src="firebase.js"></script>
</head>
<body>

<header>
    Technician Dashboard
    <button onclick="logout()" style="float:right;">Logout</button>
</header>

<div class="container">

    <div style="margin-bottom:20px;">
        <button onclick="showTab('new')" class="btn-primary">New Jobs</button>
        <button onclick="showTab('active')" class="btn-success">My Active Jobs</button>
    </div>

    <div id="new-jobs-section">
        <h3>New Available Jobs</h3>
        <div id="new-jobs-list"></div>
    </div>

    <div id="active-jobs-section" style="display:none;">
        <h3>My Working Jobs</h3>
        <div id="active-jobs-list"></div>
    </div>

</div>

<script>

let currentUserId = null;

window.addEventListener("DOMContentLoaded", function () {
    checkAuth("tech");

    auth.onAuthStateChanged(user => {
        if(user){
            currentUserId = user.uid;
            loadJobs();
        }
    });
});


function showTab(type) {
    document.getElementById('new-jobs-section').style.display =
        type === 'new' ? 'block' : 'none';

    document.getElementById('active-jobs-section').style.display =
        type === 'active' ? 'block' : 'none';
}


function loadJobs() {

    db.collection("jobs")
    .orderBy("createdAt", "desc")
    .onSnapshot(snapshot => {

        let newHtml = "";
        let activeHtml = "";

        snapshot.forEach(doc => {

            const job = doc.data();
            const id = doc.id;
            const status = job.status || "pending";

            // üîπ New jobs (only pending + not assigned)
            if (status === "pending" && !job.assignedTo) {
                newHtml += `
                    <div class="card">
                        <b>${job.customer}</b> (${job.area})<br>
                        üìû ${job.phone}<br>
                        üìù ${job.description}
                        <br><br>
                        <button class="btn-success" onclick="acceptJob('${id}')">
                            Accept Job
                        </button>
                    </div>`;
            }

            // üîπ My accepted jobs
            if (status === "accepted" && job.assignedTo === currentUserId) {

                activeHtml += `
                    <div class="card border-active">
                        <b>${job.customer}</b> - IN PROGRESS<br>
                        üìç ${job.area} | üìû ${job.phone}<br>
                        üìù ${job.description}

                        <div style="margin-top:10px;">
                            <label>Before Photo:</label>
                            <input type="file" onchange="uploadPhoto(event,'${id}','before')">
                        </div>

                        <div style="margin-top:10px;">
                            <label>After Photo:</label>
                            <input type="file" onchange="uploadPhoto(event,'${id}','after')">
                        </div>

                        <div style="margin-top:15px;">
                            <button class="btn-success"
                                ${( !job.beforePic || !job.afterPic ) ? 'disabled' : ''}
                                onclick="completeJob('${id}')">
                                Complete Job
                            </button>

                            <button class="btn-danger-outline"
                                onclick="reportJob('${id}')">
                                Report Issue
                            </button>
                        </div>
                    </div>`;
            }

        });

        document.getElementById("new-jobs-list").innerHTML =
            newHtml || "<p>No new jobs available.</p>";

        document.getElementById("active-jobs-list").innerHTML =
            activeHtml || "<p>No active jobs.</p>";

    });
}


function acceptJob(id) {

    db.collection("jobs").doc(id).update({
        status: "accepted",
        assignedTo: currentUserId
    })
    .then(() => alert("Job Accepted"))
    .catch(err => alert(err.message));
}


function completeJob(id) {

    db.collection("jobs").doc(id).update({
        status: "completed"
    })
    .then(() => alert("Job Completed"))
    .catch(err => alert(err.message));
}


function reportJob(id) {

    db.collection("jobs").doc(id).update({
        status: "reported"
    })
    .then(() => alert("Job Reported"))
    .catch(err => alert(err.message));
}


function uploadPhoto(event, jobId, type) {

    const file = event.target.files[0];
    if (!file) return;

    const ref = storage.ref("jobs/" + jobId + "_" + type + ".jpg");

    ref.put(file)
    .then(snapshot => snapshot.ref.getDownloadURL())
    .then(url => {

        let updateData = {};
        updateData[type + "Pic"] = url;

        return db.collection("jobs").doc(jobId).update(updateData);
    })
    .then(() => alert(type.toUpperCase() + " photo uploaded"))
    .catch(err => alert(err.message));
}

</script>

<style>
.border-active {
    border-left: 5px solid #28a745;
    margin-bottom: 15px;
    padding: 15px;
    background: #f9fff9;
}
</style>

</body>
</html>
