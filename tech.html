<div class="container">
    <div style="margin-bottom: 20px;">
        <button onclick="showTab('new')" class="btn-primary">New Jobs</button>
        <button onclick="showTab('active')" class="btn-success">My Active Jobs</button>
    </div>

    <div id="new-jobs-section">
        <h3>New Available Jobs</h3>
        <div id="new-jobs-list"></div>
    </div>

    <div id="active-jobs-section" style="display:none;">
        <h3>My Working Jobs</h3>
        <div id="active-jobs-list"></div>
    </div>
</div>

<script>
// Global object to track photo uploads for UI validation
let uploadStatus = {};

function showTab(type) {
    if(type === 'new') {
        document.getElementById('new-jobs-section').style.display = 'block';
        document.getElementById('active-jobs-section').style.display = 'none';
    } else {
        document.getElementById('new-jobs-section').style.display = 'none';
        document.getElementById('active-jobs-section').style.display = 'block';
    }
}

function loadJobs() {
    db.collection("jobs").orderBy("createdAt", "desc")
    .onSnapshot(snapshot => {
        let newHtml = "";
        let activeHtml = "";

        snapshot.forEach(doc => {
            const job = doc.data();
            const id = doc.id;

            // SECTION 1: PENDING JOBS (Jo koi bhi accept kar sakta hai)
            if (job.status === "pending") {
                newHtml += `
                    <div class="card">
                        <b>${job.customer}</b> (${job.area})<br>
                        <p>${job.description}</p>
                        <button class="btn-success" onclick="acceptJob('${id}')">Accept Job</button>
                    </div>`;
            }

            // SECTION 2: ACCEPTED JOBS (Jo technician ne pakad li hain)
            if (job.status === "accepted") {
                // Initialize upload status if not exists
                if(!uploadStatus[id]) uploadStatus[id] = {before: false, after: false};

                activeHtml += `
                    <div class="card border-active">
                        <div class="job-header">
                            <b>${job.customer}</b> - <span class="status-accepted">IN PROGRESS</span>
                        </div>
                        <p>üìç ${job.area} | üìû ${job.phone}</p>
                        <p>üìù ${job.description}</p>
                        
                        <div class="upload-box">
                            <div>
                                <label>1. Before Photo:</label>
                                <input type="file" onchange="uploadPhoto(event, '${id}', 'before')">
                            </div>
                            <div style="margin-top:10px">
                                <label>2. After Photo:</label>
                                <input type="file" onchange="uploadPhoto(event, '${id}', 'after')">
                            </div>
                        </div>

                        <div style="margin-top:15px">
                            <button id="comp-btn-${id}" class="btn-complete" 
                                ${(!job.beforePic || !job.afterPic) ? 'disabled style="opacity:0.5"' : ''} 
                                onclick="completeJob('${id}')">
                                Confirm & Finish Work
                            </button>
                            <button class="btn-danger-outline" onclick="reportJob('${id}')">Report Issue</button>
                        </div>
                    </div>`;
            }
        });

        document.getElementById("new-jobs-list").innerHTML = newHtml || "<p>No new jobs available.</p>";
        document.getElementById("active-jobs-list").innerHTML = activeHtml || "<p>You have no active jobs.</p>";
    });
}

function uploadPhoto(event, jobId, type) {
    const file = event.target.files[0];
    if (!file) return;

    // Show loading hint
    event.target.parentElement.style.color = "orange";
    
    const ref = storage.ref("jobs/" + jobId + "_" + type + ".jpg");

    ref.put(file).then(snapshot => {
        return snapshot.ref.getDownloadURL();
    }).then(url => {
        // Update database with image URL
        let updateData = {};
        updateData[type + "Pic"] = url; // Sets beforePic or afterPic
        
        db.collection("jobs").doc(jobId).update(updateData).then(() => {
            alert(type.toUpperCase() + " photo saved!");
            event.target.parentElement.style.color = "green";
        });
    }).catch(err => {
        alert("Upload failed: " + err.message);
    });
}

// Baki acceptJob aur completeJob functions aapke purane hi chalenge.
</script>

<style>
/* Thodi styling behtar karne ke liye */
.border-active { border-left: 5px solid #28a745; margin-bottom: 15px; padding: 15px; background: #f9fff9; }
.upload-box { background: #eee; padding: 10px; border-radius: 5px; margin-top: 10px; }
.btn-complete { background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
.btn-danger-outline { background: transparent; border: 1px solid red; color: red; padding: 8px; margin-left: 10px; border-radius: 4px; }
</style><div class="container">
    <div style="margin-bottom: 20px;">
        <button onclick="showTab('new')" class="btn-primary">New Jobs</button>
        <button onclick="showTab('active')" class="btn-success">My Active Jobs</button>
    </div>

    <div id="new-jobs-section">
        <h3>New Available Jobs</h3>
        <div id="new-jobs-list"></div>
    </div>

    <div id="active-jobs-section" style="display:none;">
        <h3>My Working Jobs</h3>
        <div id="active-jobs-list"></div>
    </div>
</div>

<script>
// Global object to track photo uploads for UI validation
let uploadStatus = {};

function showTab(type) {
    if(type === 'new') {
        document.getElementById('new-jobs-section').style.display = 'block';
        document.getElementById('active-jobs-section').style.display = 'none';
    } else {
        document.getElementById('new-jobs-section').style.display = 'none';
        document.getElementById('active-jobs-section').style.display = 'block';
    }
}

function loadJobs() {
    db.collection("jobs").orderBy("createdAt", "desc")
    .onSnapshot(snapshot => {
        let newHtml = "";
        let activeHtml = "";

        snapshot.forEach(doc => {
            const job = doc.data();
            const id = doc.id;

            // SECTION 1: PENDING JOBS (Jo koi bhi accept kar sakta hai)
            if (job.status === "pending") {
                newHtml += `
                    <div class="card">
                        <b>${job.customer}</b> (${job.area})<br>
                        <p>${job.description}</p>
                        <button class="btn-success" onclick="acceptJob('${id}')">Accept Job</button>
                    </div>`;
            }

            // SECTION 2: ACCEPTED JOBS (Jo technician ne pakad li hain)
            if (job.status === "accepted") {
                // Initialize upload status if not exists
                if(!uploadStatus[id]) uploadStatus[id] = {before: false, after: false};

                activeHtml += `
                    <div class="card border-active">
                        <div class="job-header">
                            <b>${job.customer}</b> - <span class="status-accepted">IN PROGRESS</span>
                        </div>
                        <p>üìç ${job.area} | üìû ${job.phone}</p>
                        <p>üìù ${job.description}</p>
                        
                        <div class="upload-box">
                            <div>
                                <label>1. Before Photo:</label>
                                <input type="file" onchange="uploadPhoto(event, '${id}', 'before')">
                            </div>
                            <div style="margin-top:10px">
                                <label>2. After Photo:</label>
                                <input type="file" onchange="uploadPhoto(event, '${id}', 'after')">
                            </div>
                        </div>

                        <div style="margin-top:15px">
                            <button id="comp-btn-${id}" class="btn-complete" 
                                ${(!job.beforePic || !job.afterPic) ? 'disabled style="opacity:0.5"' : ''} 
                                onclick="completeJob('${id}')">
                                Confirm & Finish Work
                            </button>
                            <button class="btn-danger-outline" onclick="reportJob('${id}')">Report Issue</button>
                        </div>
                    </div>`;
            }
        });

        document.getElementById("new-jobs-list").innerHTML = newHtml || "<p>No new jobs available.</p>";
        document.getElementById("active-jobs-list").innerHTML = activeHtml || "<p>You have no active jobs.</p>";
    });
}

function uploadPhoto(event, jobId, type) {
    const file = event.target.files[0];
    if (!file) return;

    // Show loading hint
    event.target.parentElement.style.color = "orange";
    
    const ref = storage.ref("jobs/" + jobId + "_" + type + ".jpg");

    ref.put(file).then(snapshot => {
        return snapshot.ref.getDownloadURL();
    }).then(url => {
        // Update database with image URL
        let updateData = {};
        updateData[type + "Pic"] = url; // Sets beforePic or afterPic
        
        db.collection("jobs").doc(jobId).update(updateData).then(() => {
            alert(type.toUpperCase() + " photo saved!");
            event.target.parentElement.style.color = "green";
        });
    }).catch(err => {
        alert("Upload failed: " + err.message);
    });
}

// Baki acceptJob aur completeJob functions aapke purane hi chalenge.
</script>

<style>
