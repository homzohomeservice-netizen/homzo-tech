<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel - Homzo</title>
    <link rel="stylesheet" href="style.css">

    <!-- Firebase v8 CDN -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <script src="firebase.js"></script>
</head>

<body>

<header>
    Admin Dashboard

    <div class="top-buttons">
        <button onclick="changePassword()" class="btn-primary">Change Password</button>
        <button onclick="logout()" class="logout-btn">Logout</button>
    </div>
</header>

<div class="container">

    <!-- Add Technician -->
    <div class="card">
        <h3>Add Technician</h3>

        <input type="email" id="techEmail" placeholder="Technician Email">
        <input type="password" id="techPass" placeholder="Technician Password">
        <input type="text" id="techArea" placeholder="Area">

        <button onclick="addTech()" class="btn-primary">
            Create Technician
        </button>
    </div>

    <!-- Add Job -->
    <div class="card">
        <h3>Add New Job</h3>
        <input type="text" id="customer" placeholder="Customer Name">
        <input type="text" id="phone" placeholder="Phone">
        <input type="text" id="area" placeholder="Area">
        <textarea id="description" placeholder="Job Description"></textarea>

        <select id="assignTech">
            <option value="">Assign Technician (Optional)</option>
        </select>

        <button class="btn-success" onclick="addJob()">Add Job</button>
    </div>

    <!-- Active Jobs -->
    <div class="card">
        <h3>Active Jobs</h3>
        <div id="jobs"></div>
    </div>

    <!-- History -->
    <div class="card">
        <h3>Completed / Reported</h3>
        <div id="history"></div>
    </div>

</div>

<script>

window.addEventListener("DOMContentLoaded", function () {
    checkAuth("admin");
    requestNotification();
    loadJobs();
    loadTechnicians();
});

/* =========================
   LOAD TECHNICIANS
========================= */

function loadTechnicians() {

    db.collection("users")
    .where("role", "==", "tech")
    .onSnapshot(snapshot => {

        let options = `<option value="">Assign Technician (Optional)</option>`;

        snapshot.forEach(doc => {
            const user = doc.data();
            options += `<option value="${doc.id}|${user.name}">
                            ${user.name} (${user.area})
                        </option>`;
        });

        document.getElementById("assignTech").innerHTML = options;
    });
}

/* =========================
   ADD JOB
========================= */

function addJob() {

    const customer = document.getElementById("customer").value;
    const phone = document.getElementById("phone").value;
    const area = document.getElementById("area").value;
    const description = document.getElementById("description").value;
    const techData = document.getElementById("assignTech").value;

    if(!customer || !phone || !area || !description){
        alert("All fields required");
        return;
    }

    let assignedTo = "";
    let assignedName = "";

    if (techData) {
        const parts = techData.split("|");
        assignedTo = parts[0];
        assignedName = parts[1];
    }

    db.collection("jobs").add({
        customer,
        phone,
        area,
        description,
        assignedTo,
        assignedName,
        status: "pending",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    })
    .then(() => {
        alert("Job Added");

        document.getElementById("customer").value = "";
        document.getElementById("phone").value = "";
        document.getElementById("area").value = "";
        document.getElementById("description").value = "";
        document.getElementById("assignTech").value = "";
    })
    .catch(error => alert(error.message));
}

/* =========================
   LOAD JOBS
========================= */

function loadJobs() {

    db.collection("jobs")
    .orderBy("createdAt", "desc")
    .onSnapshot(snapshot => {

        let activeHTML = "";
        let historyHTML = "";

        snapshot.forEach(doc => {

            const job = doc.data();
            const id = doc.id;
            const status = job.status || "pending";

            const jobCard = `
                <div class="card">
                    <b>${job.customer}</b> (${job.area})<br>
                    ${job.phone}<br>
                    ${job.description}<br>
                    ${job.assignedName ? "<b>Assigned To:</b> " + job.assignedName + "<br>" : ""}

                    <div class="job-status status-${status}">
                        ${status.toUpperCase()}
                    </div>

                    <button onclick="editJob('${id}','${job.customer}','${job.phone}','${job.description}','${job.area}')" class="btn-primary">Edit</button>

                    <button onclick="deleteJob('${id}')" class="btn-danger">Delete</button>
                </div>
            `;

            if (status === "completed" || status === "reported") {
                historyHTML += jobCard;
            } else {
                activeHTML += jobCard;
            }

        });

        document.getElementById("jobs").innerHTML = activeHTML;
        document.getElementById("history").innerHTML = historyHTML;

    });
}

/* =========================
   DELETE JOB
========================= */

function deleteJob(id) {
    if(confirm("Delete this job?")) {
        db.collection("jobs").doc(id).delete()
        .then(() => alert("Job Deleted"))
        .catch(error => alert(error.message));
    }
}

/* =========================
   EDIT JOB
========================= */

function editJob(id, customer, phone, description, area) {

    const newCustomer = prompt("Customer Name:", customer);
    const newPhone = prompt("Phone:", phone);
    const newDesc = prompt("Description:", description);
    const newArea = prompt("Area:", area);

    if(newCustomer && newPhone && newDesc && newArea) {
        db.collection("jobs").doc(id).update({
            customer: newCustomer,
            phone: newPhone,
            description: newDesc,
            area: newArea
        })
        .then(() => alert("Job Updated"))
        .catch(error => alert(error.message));
    }
}

/* =========================
   ADD TECHNICIAN (SAFE)
========================= */

function addTech() {

    const email = document.getElementById("techEmail").value;
    const pass = document.getElementById("techPass").value;
    const area = document.getElementById("techArea").value;

    if(!email || !pass || !area){
        alert("All fields required");
        return;
    }

    let secondaryApp;

    try {
        secondaryApp = firebase.app("Secondary");
    } catch (e) {
        secondaryApp = firebase.initializeApp(firebase.app().options, "Secondary");
    }

    secondaryApp.auth()
    .createUserWithEmailAndPassword(email, pass)
    .then(userCredential => {

        const uid = userCredential.user.uid;

        db.collection("users").doc(uid).set({
            name: email,
            role: "tech",
            area: area
        });

        alert("Technician Created Successfully");

        secondaryApp.auth().signOut();
        secondaryApp.delete();

        document.getElementById("techEmail").value = "";
        document.getElementById("techPass").value = "";
        document.getElementById("techArea").value = "";
    })
    .catch(error => {
        alert(error.message);
        secondaryApp.delete();
    });
}

</script>

</body>
</html>
